.. _monitor_alert_forecast:

================================================================================
Resource Forecast
================================================================================

The OpenNebula Resource Forecast system provides short-term and long-term predictions for resource usage across hosts and virtual machines. By forecasting metric trends and performance related to CPU, memory, network, and disk usage, it enables administrators to proactively manage resources. This predictive capability helps optimize resource allocation, anticipate potential bottlenecks, and ensure the efficiency and stability of both infrastructure and virtual resources.

By integrating forecasting with the Distributed Resource Scheduler (DRS), cloud administrators gain access to a proactive tool for intelligent scheduling and resource optimization. This integration enables the system to anticipate potential issues in virtual machine workloads, facilitating dynamic adjustments to prevent performance bottlenecks, enhance workload balancing, and ensure optimal utilization of available resources. As a result, overall cluster efficiency, reliability, and performance can be significantly improved.

Long-term Forecast
================================================================================

Long-term forecast information is accessible through the CLI and Sunstone. Using Sunstone, when selecting a Virtual Machine or a Host, the "Monitoring" tab displays not only real-time resource usage data but also predicted long-term forecasts. These forecasts provide valuable insights into expected resource consumption trends, helping cloud administrators plan and allocate resources more effectively. 

[INSERT SUNSTONE IMAGE HERE FOR LONG-TERM FORECAST]

You can use also the CLI to access information about the long-term forecast.

[INSERT CLI INFORMATION HERE FOR LONG-TERM FORECAST]

By default, long-term forecast is performed for the next 30 days.

Short-term Forecast
================================================================================
Short-term forecasts are utilized by the Predictive DRS to optimize cluster load distribution based on CPU, memory, disk, and network predictions. To enable predictive capabilities for DRS, refer to the section [DRS section reference]. This ensures that scheduling decisions are informed by accurate and data-driven insights, enhancing resource efficiency.

Information about short-term forecast can be accessed also using Sunstone. When selecting a Virtual Machine or a Host, the "Monitoring" tab displays not only real-time resource usage data but also predicted short-term forecasts.

[INSERT SUNSTONE IMAGE HERE FOR SHORT-TERM FORECAST]

You can use also the CLI to access information about the long-term forecast.

[INSERT CLI INFORMATION HERE FOR SHORT-TERM FORECAST]

By default, short-term forecast is performed for the next 5 minutes.

Forecast generation
================================================================================
Forecasts are generated by using the OpenNebula Built-in monitoring system (see :ref:`monitor_alert_monitor`). At defined intervals, a prediction probe is executed for both Hosts and Virtual Machines to analyze real-time resource usage metrics, including CPU, memory, disk, and network utilization.

Each host maintains a dedicated database ('/var/tmp/one_db/host.db') that is continuously updated during monitoring cycles. This database stores historical metrics and is used for time-series analysis and prediction generation. The forecast computation process is distributed across all hosts within a cluster to enhance scalability and efficiency. For each VM running on a host, an individual database is created and stored in '/var/tmp/one_db' as '<VM_ID>.db'.

.. note:: If a VM is migrated, the related DB will be created from scratch in the new host where the VM will be allocated. This will impact the forecast of that VM until enough data is monitored.

The forecast computation process accesses the stored metrics and performs statistical analysis to identify trends, patterns, and seasonal variations. Using this analysis, the system computes predictive models that estimate future resource consumption. The generated predictions are then sent to the OpenNebula monitoring system, where they are integrated with existing monitoring data and made accessible via Sunstone, CLI or used by the Predictive DRS.

The retention period for both Host and Virtual Machine databases is configurable, enabling administrators to manage storage utilization efficiently while maintaining prediction accuracy. Database retention can impact the accuracy of predictions, particularly for long-term forecasts. The forecast module analyzes all historical data in the database to decompose time series data for different metrics into trends and seasonality. Depending on the data's seasonality and the duration of the long-term forecast, the database retention period should be appropriately configured, considering both the required storage size and prediction accuracy. 

For further details on configuring forecast retention or optimizing prediction accuracy, refer to the next section.

Configuration
================================================================================

The configuration file for the Resource Forecast can be found in ``/var/lib/one/remotes/kvm-probes.d/forecast.conf``.

The default configuration is the following

.. code:: yaml

    # This section is related to the configuration for DB retention and forecast period
    # related to the hosts
    host:
        db_retention: 4 # Number of weeks
        forecast_period: 5 # Number of minutes
        forecast_far_period: 720 # Number of hours

    # This section is related to the configuration for DB retention and forecast 
    # related to the virtual machines
    virtualmachine:
        db_retention: 2 # Number of weeks
        forecast_period: 5 # Number of minutes
        forecast_far_period: 48 # Number of hours


The configuration file consists of two sections, one related to the Host and the other to the Virtual Machine. 

By default, Host DB retention is set to 4 weeks, the short term forecast to 5 minutes and the long-term forecast to 720 hours (i.e., 30 days).

By default, Virtual Machine DB retention is set to 2 weeks, the short term forecast to 5 minutes and the long-term forecast to 48 hours (i.e., 2 days).

The estimated size of the Host database for 4 weeks of data across 6 metrics with a 2-minute monitoring interval is approximately 2.5 MB. Instead, the estimated size of the Virtual Machine database for 2 weeks of data across 8 metrics with a 30-second monitoring interval is around 6.5 MB.